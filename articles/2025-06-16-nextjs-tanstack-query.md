---
layout: post
title: –Ø–∫ –æ–± º—î–¥–Ω–∞—Ç–∏ nextjs server functions —ñ–∑ tanstack query —ñ –º–∞—Ç–∏ –∑ —Ç–æ–≥–æ –∑–∏—Å–∫.
permalink: /blog/2025-06-16-nextjs-tanstack-query.html
tags: #nextjs #tanstack-query #integration
---

–û—Å—Ç–∞–Ω–Ω—ñ–º —á–∞—Å–æ–º —è —á–∞—Å—Ç–æ –ø—Ä–∞—Ü—é—é –∑—ñ —Å—Ç–µ–∫–æ–º [`Next.js`](https://nextjs.org/docs) + [`TanStack Query`](https://tanstack.com/query/latest/docs/framework/react/overview). –ö–æ–ª–∏—Å—å –≤–∏–≥–∞–¥–∞–≤ –¥–ª—è —Å–µ–±–µ –ø—ñ–¥—Ö—ñ–¥ –¥–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É–≤–∞–Ω–Ω—è –º–æ–¥—É–ª—ñ–≤, —â–æ–± –º–∞—Ç–∏ –∑–º–æ–≥—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Å–µ—Ä–≤–µ—Ä–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó —è–∫ –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ, —Ç–∞–∫ —ñ –≤ –∫–ª—ñ—î–Ω—Ç—Å—å–∫–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö.

–¶–µ –¥—É–∂–µ –∑—Ä—É—á–Ω–æ, –∫–æ–ª–∏ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –≤—Å—è –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å TanStack Query –∑ –π–æ–≥–æ –∫–µ—à—É–≤–∞–Ω–Ω—è–º, –≥—ñ–¥—Ä–∞—Ü—ñ—î—é, –º—É—Ç–∞—Ü—ñ—è–º–∏ —Ç–æ—â–æ, –∞–ª–µ –≤–æ–¥–Ω–æ—á–∞—Å —Ö–æ—á–µ—Ç—å—Å—è ‚Äú–ø—Ä–∏—Ö–æ–≤–∞—Ç–∏‚Äù –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫—É, —Å—Ç—Ä—É–∫—Ç—É—Ä—É –±–∞–∑–∏ –¥–∞–Ω–∏—Ö –∞–±–æ —Å—Ç–æ—Ä–æ–Ω–Ω—î API –≤—ñ–¥ –∑–∞–π–≤–∏—Ö –æ—á–µ–π.

<!--more-->

## üîß –£ —á–æ–º—É –∫–æ–Ω—Ü–µ–ø—Ü—ñ—è

- –ß—ñ—Ç–∫–∏–π –º–æ–¥—É–ª—å–Ω–∏–π –ø–æ–¥—ñ–ª
- –£—Å—ñ –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö, –∑–æ–≤–Ω—ñ—à–Ω—ñ—Ö API —Ç–∞ –ø–æ—Ç—É–∂–Ω–∞ –±—ñ–∑–Ω–µ—Å‚Äë–ª–æ–≥—ñ–∫–∞ –º—ñ—Å—Ç—è—Ç—å—Å—è –≤ –æ–∫—Ä–µ–º–æ–º—É —à–∞—Ä—ñ ‚Äî —Å–µ—Ä–≤–µ—Ä–Ω–æ–º—É –º–æ–¥—É–ª—ñ.
- –¶–µ –¥–æ–∑–≤–æ–ª—è—î –∫–æ–Ω—Ç—Ä–æ–ª—é–≤–∞—Ç–∏, —â–æ —Ç–∞ —è–∫ –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è –¥–∞–ª—ñ —É –∫–ª—ñ—î–Ω—Ç.
- –£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω—ñ —Å–µ—Ä–≤–µ—Ä–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó.
- –ü–∏—à–µ—Ç–µ —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó —Ç–∏–ø—É `fetchUser()`, `updatePost()`, —è–∫—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –æ–¥—Ä–∞–∑—É –≤ pages/api (–∞–±–æ app-—Ä–æ—É—Ç–∏–Ω–≥—É - next.js) —ñ –≤ –∫–ª—ñ—î–Ω—Ç—Å—å–∫–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö —á–µ—Ä–µ–∑ TanStack Query.
- –¢–∞–∫–∏–º —á–∏–Ω–æ–º –æ–¥–Ω–∞ –π —Ç–∞ –∂ —Ñ—É–Ω–∫—Ü—ñ—è –≥—Ä–∞—î —Ä–æ–ª—å —ñ API-–µ–Ω–¥–ø–æ—ñ–Ω—Ç—É, —ñ –∑–∞–ø–∏—Ç—É –∑ –∫–ª—ñ—î–Ω—Ç–∞ –∑ –∫–µ—à–µ–º, –º—É—Ç–∞—Ü—ñ—è–º–∏, –≥—ñ–¥—Ä–∞—Ü—ñ—î—é.
- –ú–∞–∫—Å–∏–º—É–º –ø–µ—Ä–µ–≤–∞–≥ TanStack Query
- –ù–∞–¥—ñ–π–Ω–µ –∫–µ—à—É–≤–∞–Ω–Ω—è, –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—ñ—Å–ª—è –º—É—Ç–∞—Ü—ñ–π, –≥—ñ–¥—Ä–∞—Ü—ñ—è —Ç–æ—â–æ ‚Äî –±–µ–∑ –¥—É–±–ª—é–≤–∞–Ω–Ω—è –ª–æ–≥—ñ–∫–∏ —á–∏ –ø–æ–≤—Ç–æ—Ä–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤.
- –ü—Ä–æ—Å—Ç–æ—Ç–∞ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è ‚Äî –∞–¥–∂–µ –∫–ª—ñ—î–Ω—Ç –∑–∞–ø—É—Å–∫–∞—î —Ç—ñ —Å–∞–º—ñ —Ñ—É–Ω–∫—Ü—ñ—ó, —â–æ –π —Å–µ—Ä–≤–µ—Ä, –±–µ–∑ –¥—É–±–ª—é–≤–∞–Ω–Ω—è –∫–æ–¥—É.
- –Ü–∑–æ–ª—è—Ü—ñ—è –±—ñ–∑–Ω–µ—Å‚Äë–ª–æ–≥—ñ–∫–∏
- –í–∏—Ç—è–≥—É—î—Ç–µ –≤—Å—é —Å—É—Ç–Ω—ñ—Å—Ç—å –∑–∞–ø–∏—Ç—ñ–≤ —É –∑–∞—Ö–∏—â–µ–Ω–∏–π —à–∞—Ä.
- –ö–ª—ñ—î–Ω—Ç –Ω–µ –±–∞—á–∏—Ç—å –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ–≥–æ –≤–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è ‚Äî —Ç—ñ–ª—å–∫–∏ –æ–±–º–µ–∂–µ–Ω–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å.

## –°–ø–æ—á–∞—Ç–∫—É —Ü–µ –≤–∏–≥–ª—è–¥–∞–ª–æ —Ü–µ –Ω–∞—Å—Ç—É–ø–Ω–∏–º —á–∏–Ω–æ–º

### @/api/entity/server.ts

–§–∞–π–ª —ñ–∑ —Å–µ—Ä–≤–µ—Ä–Ω–æ—é —Ñ—É–Ω–∫—Ü—ñ—î—é —è–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –≤–∏–∫–ª—é—á–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ. –î–∞–ª—ñ —ó—ó –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —É —Å–µ—Ä–≤–µ—Ä–Ω–∏—Ö –º–æ–¥—É–ª—è—Ö.

```ts
'use server';

export async function getEntity(id: number) {
  const entities = {
    1: {title: 'Entity #1'},
    2: {title: 'Entity #2'},
  };
  // –¶–µ —ñ–º—ñ—Ç–∞—Ü—ñ—è –≤–∑–∞—î–º–æ–¥—ñ—ó —ñ–∑ –ë–î —á–∏ —Å—Ç–æ—Ä–æ–Ω–Ω—ñ–º API
  return Promise.resolve(entities[id]);
}
```

### @/api/entity/index.ts

–ú–æ–¥—É–ª—å —ñ–∑ —Ñ—É–Ω–∫—Ü—ñ—î—é, —â–æ —ñ–Ω—Å—Ç–∞–Ω—Ü—ñ—é—î –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–π –æ–± º—î–∫—Ç query. –î–∞–ª—ñ –π–æ–≥–æ –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —É –∫–ª—ñ—î–Ω—Ç—Å—å–∫–∏—Ö –º–æ–¥—É–ª—è—Ö.

```ts
import {queryOptions} from '@tanstack/react-query';
import {getEntity} from './server';

export const GET_ENTITY_KEY_BASE = ['entity'];

export function getEntityQuery(id: number) {
  return queryOptions({
    queryKey: [...GET_ENTITY_KEY_BASE, id],
    queryFn: () => getEntity(id),
  });
}
```

### @/app/page.tsx

–ú–æ–¥—É–ª—å —Å—Ç–æ—Ä—ñ–Ω–∫–∏, —â–æ –±—É–¥–µ –ø—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏—Ç–∏—Å—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ, –∞ —Ç–∞–∫–æ–∂ –≥—ñ–¥—Ä—É–≤–∞—Ç–∏ QueryClient –¥–∞–Ω–∏–º–∏ –∑—ñ–±—Ä–∞–Ω–∏–º–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ.

```ts
import {HydrationBoundary, dehydrate} from '@tanstack/react-query';
import {getEntityQuery, GET_ENTITY_KEY_BASE} from '@/api/entity';
import {getEntity} from '@/api/entity/server';

type PageProps = {
  params: Promise<{id: string}>;
}

export async function generateMetadata({params}: PageProps) {
  const id = Number((await params).id);

  const entity = await getEntity(id);

  return {title: entity.title};
}

export default async function Page({params}: PageProps) {
  const queryClient = getQueryClient();

  const id = Number((await params).id);

  await queryClient.prefetchQuery(getEntityQuery(id));

  return (
    <HydrationBoundary state={dehydrate(queryClient)}>
      <Container  />
    </HydrationBoundary>
  );
}
```

### –ü—Ä–æ–±–ª–µ–º–∏

–Ø–∫ –≤–∏–¥–Ω–æ, –∫–æ–ª–∏ —Ç–∞–∫–∏—Ö –∫–≤–µ—Ä—ñ–≤ —Å—Ç–∞—î –±–∞–≥–∞—Ç–æ, –±—É–¥–µ–º–æ –º–∞—Ç–∏ –≤–µ–ª–∏–∫—É –∫—ñ–ª—å–∫–∏—Å—Ç—å —Ñ–∞–∫—Ç–∏—á–Ω–æ –æ–¥–Ω–∞–∫–æ–≤–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π. –Ñ–¥–∏–Ω–∞ —Ä—ñ–∑–Ω–∏—Ü—è, —Ü–µ `queryKey` —ñ `queryFn`.

–¢–æ –∂ –Ω–∞ –¥–Ω—è—Ö –≤–∏–≥–∞–¥–∞–≤ –∞–±—Å—Ç—Ä–∞–∫—Ü—ñ—é, —â–æ–± —Ç—Ä–æ—à–∫–∏ —Å–ø—Ä–æ—Å—Ç–∏—Ç–∏ —Å–æ–±—ñ –∂–∏—Ç—Ç—è –≤ —Ü—å–æ–º—É. –Ü–∑ –ø—Ä–æ—Ñ—ñ—Ç—É - –º–µ–Ω—à–µ –æ–¥–Ω–∞–∫–æ–≤–æ–≥–æ –∫–æ–¥—É, –ø–æ–≤–Ω–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ —Ç–∏–ø—ñ–≤, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –≥–Ω—É—á–∫—ñ—Å—Ç—å, –∞ —Ç–∞–∫–æ–∂ –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∏–≥–∞–¥—É–≤–∞—Ç–∏ —ñ–º–µ–Ω–∞ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞–º —â–æ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å –±–∞–∑–æ–≤–∏–π –∫–ª—é—á –∫–≤–µ—Ä—ñ. –¶–µ –º–æ–∂–µ –∑–Ω–∞–¥–æ–±–∏—Ç–∏—Å—å –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —á–∏ —ñ–Ω–≤–∞–ª—ñ–¥–∞—Ü—ñ—ó –∫–µ—à–∞ –∫–≤–µ—Ä—ñ–≤, –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó –º—É—Ç–∞—Ü—ñ—ó —Ü–∏—Ö –¥–∞–Ω–∏—Ö.

## –¢–µ–ø–µ—Ä –æ—Å—å —Ç–∞–∫

### @/api/entity/server.ts

–ú–æ–¥—É–ª—å —ñ–∑ —Å–µ—Ä–≤–µ—Ä–Ω–æ—é —Ñ—É–Ω–∫—Ü—ñ—î—é –ª–∏—à–∞—î—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω.

```ts
'use server';

export async function getEntity(id: number) {
  const entities = {
    1: {title: 'Entity #1'},
    2: {title: 'Entity #2'},
  };
  // –¶–µ —ñ–º—ñ—Ç–∞—Ü—ñ—è –≤–∑–∞—î–º–æ–¥—ñ—ó —ñ–∑ –ë–î —á–∏ —Å—Ç–æ—Ä–æ–Ω–Ω—ñ–º API
  return Promise.resolve(entities[id]);
}
```

### @/utils/query.ts

–í–ª–∞—Å–Ω–µ —Å–∞–º–∞ —ñ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü—ñ—è –∫–ª–∞—Å–∞ —É—Ç–∏–ª—ñ—Ç–∏

```ts
import {QueryKey} from '@tanstack/react-query';

export class Query<
  QueryFn extends (params: any) => any,
  Key extends QueryKey = QueryKey,
  Params = Parameters<QueryFn>[0],
  Data = ReturnType<QueryFn>,
> {
  public queryFn: QueryFn;
  public baseKey: Key;

  constructor(queryFn: QueryFn, baseKey: Readonly<Key>) {
    this.baseKey = baseKey;
    this.queryFn = queryFn;
  }

  public getKey = (params: Partial<Params>) => {
    return [...this.baseKey, params] as const;
  };

  public getQuery = (params: Params) => {
    return {
      queryKey: this.getKey(params),
      queryFn: () => this.queryFn(params) as Data,
    };
  };
}
```

–Ü–∑ —Ç–∏–ø–∞–º–∏ —â–µ –¥–æ –∫—ñ–Ω—Ü—è –Ω–µ —Ä–æ–∑—ñ–±—Ä–∞–≤—Å—è, —â–æ–± –±—É–ª–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≥–∞—Ä–Ω–æ, –∞–ª–µ —Ü–∏–º –≤–∂–µ –º–æ–∂–Ω–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ç–∏—Å—å.

### @/api/entity/index.ts

–û–± º—î–∫—Ç –∫–≤–µ—Ä—ñ —ñ–Ω—Å—Ç–∞–Ω—Ü—ñ—é—î—Ç—å—Å—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Ç–æ–≥–æ –∫–ª–∞—Å—É —É—Ç–∏–ª—ñ—Ç–∏.

```ts
import {Query} from '@/utils/query';
import {getEntity} from './server';

export const getEntityQuery = new Query(getEntity, ['entity'] as const);
```

–¢–µ–ø–µ—Ä —ñ–∑ –æ–± º—î–∫—Ç–∞ `getEntityQuery` –º–∞—î–º–æ –¥–æ—Å—Ç—É–ø –¥–æ:

- –°–µ—Ä–≤–µ—Ä–Ω–æ—ó —Ñ—É–Ω–∫—Ü—ñ—ó –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `getEntityQuery.queryFn(id)`.
- –û–± º—î–∫—Ç–∞ –∫–≤–µ—Ä—ñ —á–µ—Ä–µ–∑ `getEntityQuery.getQuery(id)`.
- –ë–∞–∑–∏ –∫–ª—é—á–∞, –∑–∞–≤–¥—è–∫–∏ `getEntityQuery.baseKey`
- –ê —Ç–∞–∫–æ–∂, –º–æ–∂–µ–º–æ –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –ø–æ–≤–Ω–∏–π –∫–ª—é—á. `getEntityQuery.getKey(id)`

### @/app/page.tsx

–ú–æ–¥—É–ª—å —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –∑ —è–∫–æ–≥–æ –≤–∏–¥–Ω–æ —Ä—ñ–∑–Ω–∏—Ü—é. –¢–µ–ø–µ—Ä –¥–æ—Å—Ç–∞—Ç–Ω–æ —ñ–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –æ–± º—î–∫—Ç –∑ —è–∫–æ–≥–æ –º–∞—î–º–æ –¥–æ—Å—Ç—É–ø –æ–¥—Ä–∞–∑—É —ñ –¥–æ —Å–µ—Ä–≤–µ—Ä–Ω–æ—ó —Ñ—É–Ω–∫—Ü—ñ—ó, —ñ –¥–æ —Å–∞–æ–º—ó –∫–≤–µ—Ä—ñ, –∞ —Ç–∞–∫–æ–∂ –±–∞–∑–æ–≤–æ–≥–æ –∫–ª—é—á–∞ —á–∏ –ø–æ–≤–Ω–æ–≥–æ –∑–∞ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—Å—Ç—ñ.

```ts
import {HydrationBoundary, dehydrate} from '@tanstack/react-query';
import {getEntityQuery} from '@/api/entity';

type PageProps = {
  params: Promise<{id: string}>;
}

export async function generateMetadata({params}: PageProps) {
  const id = Number((await params).id);

  const entity = await getEntityQuery.queryFn(id);

  return {title: entity.title};
}

export default async function Page({params}: PageProps) {
  const queryClient = getQueryClient();

  const id = Number((await params).id);

  await queryClient.prefetchQuery(getEntityQuery.getQuery(id));

  return (
    <HydrationBoundary state={dehydrate(queryClient)}>
      <Container  />
    </HydrationBoundary>
  );
}
```

–¢–∞–∫–∏–π –ø—ñ–¥—Ö—ñ–¥ –≥–∞—Ä–∞–Ω—Ç—É—î –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ç–æ—ó —Å–∞–º–æ—ó —Å–µ—Ä–≤–µ—Ä–Ω–æ—ó —Ñ—É–Ω–∫—Ü—ñ—ó —è–∫ –≤ –∫–ª—ñ—î–Ω—Ç—Å—å–∫–∏—Ö –º–æ–¥—É–ª—è—Ö —Ç–∞–∫ —ñ –≤ —Å–µ—Ä–≤–µ—Ä–Ω–∏—Ö. –¢–∏–ø–∏ –ø–æ–≤–Ω—ñ—Å—Ç—é —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω—ñ, —Ç–æ–±—Ç–æ —è–∫—â–æ —Å–µ—Ä–≤–µ—Ä–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –∑–º—ñ–Ω–∏—Ç—å —Å–≤—ñ–π API —Ü–µ –≤–ø–ª–∏–Ω–µ —ñ –Ω–∞ –≤—Å—ñ –∫–ª—ñ—î–Ω—Ç—Å—å–∫—ñ –∫–≤–µ—Ä—ñ –ø–æ—Ö—ñ–¥–Ω—ñ –≤—ñ–¥ –Ω–µ—ó. –ö–ª—é—á –∫–≤–µ—Ä—ñ —Ç–∞–∫–æ–∂ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–∏–π —ñ–∑ –∫–≤–µ—Ä–µ—é.

–í —Ä–∞–∑—ñ —è–∫—â–æ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –∑–º—ñ–Ω–∏—Ç–∏ –ª–æ–≥—ñ–∫—É –∑–∞ —è–∫–æ—é —Ñ–æ—Ä–º—É—î—Ç—å—Å—è –ø–æ–≤–Ω–∏–π –∫–ª—é—á, –º–æ–∂–Ω–∞ –≤—ñ–¥–Ω–∞—Å–ª—ñ–¥—É–≤–∞—Ç–∏—Å—å –≤—ñ–¥ –∫–ª–∞—Å—É `Query` –∑–º—ñ–Ω–∏—Ç–∏ —ñ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü—ñ—é –º–µ—Ç–æ–¥–∞ —ñ –≤—É–∞–ª—è...

–ü–∏—Ç–∞–Ω–Ω—è/–ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó/–æ–±—É—Ä–µ–Ω–Ω—è –≤ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ, —è–∫—â–æ —Ä–∞–ø—Ç–æ–º.
